<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }
        .section {
            width: 100%;
            height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #startButton {
            padding: 10px 20px;
            font-size: 18px;
            color: white;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #startButton:hover {
            background-color: #0056b3;
        }

        h1 {
            font-size: 36px;
            margin: 0;
            text-align: center;
        }
        h2 {
            font-size: 30px;
            margin: 0;
            text-align: center;
        }

        #top-page {
            border: double 5px gray;
            margin-top: 50px;
            margin-bottom: 10%;
            padding: 10px 20px;
            font-size: 20px;
            color: black;
            border-radius: 5px;
            cursor: pointer;
        }

        #top-page:hover {
            background-color: #0056b3;
            color: white;
        }

        .progress-container {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .button {
            border: double 5px gray;
            padding: 15px 30px;
            font-size: 20px;
            background-color: white;
            color: black;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
            visibility: hidden; 
        }

        .button.enabled {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }

        #iframe-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .nothing-pages {
            position: absolute;
            margin-top: 15%;
        }
        .nothing-pages.enabled {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ç§»è¡Œä¸­è‡¨æ™‚ã‚µã‚¤ãƒˆ -->
    <div class="section">
        <h1>âš ï¸ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŸã‚ã€ã‚µã‚¤ãƒˆã®æ©Ÿèƒ½ã‚’ä¸€éƒ¨åˆ¶é™ã—ã¦ã„ã¾ã™âš ï¸</h1>
        <h2>ã”ä¸ä¾¿ã‚’ãŠã‹ã‘ã—ã¦ã—ã¾ã„ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“<br>ğŸ‘‡ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒšãƒ¼ã‚¸ã¯ä»¥ä¸‹ã¨ãªã£ã¦ã„ã¾ã™ğŸ‘‡</h2>
        <h3 class="nothing-pages" id="nothing-pages">ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªä»–ãƒšãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</h3>
        <button id="top-page" data-path="http://10.204.227.151:30080/" class="button">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</button>
        <div class="progress-container">
            <button id="cart" data-path='http://10.204.227.151:30080/cart' class="button">ãŠè²·ã„ç‰©ã‚«ã‚´</button>
            <button id="info" data-path='http://10.204.227.151:30080/info' class="button">ã‚¤ãƒ³ãƒ•ã‚©</button>
            <button id="shop" data-path='http://10.204.227.151:30080/shop' class="button">ã‚·ãƒ§ãƒƒãƒ—</button>
            <button id="account" data-path="http://10.204.227.151:30080/my-account" class="button">ãƒã‚¤ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
            <button id="pay" data-path="http://10.204.227.151:30080/checkout" class="button">æ”¯æ‰•ã„</button>
        </div>
    </div>

    <!-- ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚µã‚¤ãƒˆ -->
    <!-- <div class="section" id="iframe-container">
        <iframe src="http://10.204.227.151:30080/"></iframe>
    </div> -->

    <script>
        // let hasdrected = false;

        // async function checkAndRedirect() {
        //     try {
        //         const response = await fetch('/check-variable'); // ã‚µãƒ¼ãƒãƒ¼ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        //         if (!response.ok) {
        //             throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        //         }

        //         const data = await response.json();
        //         if (data.redirect) {
        //             // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒTrueã®å ´åˆã¯æŒ‡å®šã•ã‚ŒãŸURLã«ç§»å‹•
        //             window.location.href = data.url;
        //         } else {
        //             console.log("ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¯ä¸è¦ã§ã™");
        //         }
        //     } catch (error) {
        //         console.error('ã‚¨ãƒ©ãƒ¼:', error);
        //     }
        // }

        async function checkFunctionStatus() {
            try {
                const response = await fetch('/check-status');
                if (!response.ok) {
                    throw new Error("Failed to fetch function status");
                }
                const data = await response.json();
                return data.completed;
            } catch (error) {
                console.error("Error checking function status:", error);
                return false;
            }
        }

        async function fetchProgress() {
            try {
                const response = await fetch('/progress');
                if (!response.ok) {
                    throw new Error("Failed to fetch progress data");
                }
                return await response.json();
            } catch (error) {
                console.error("Error fetching progress:", error);
                return null;
            }
        }

        function enableButton(button) {
            if (button) {
                button.classList.add("enabled");
                 // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
                button.addEventListener("click", () => {
                    const path = button.getAttribute("data-path");
                    if (path) {
                        window.location.href = path; // URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    }
                });
            }
        }

        async function monitorProgressAndStatus() {
            const buttons = document.querySelectorAll("[data-path]");
            const completionFlags = Array.from(buttons).map(() => false);
            const nothingPagesMessage = document.getElementById("nothing-pages");
            const topPageButton = document.getElementById("top-page");

            const interval = setInterval(async () => {
                try {
                    const progressData = await fetchProgress();
                    const isCompleted = await checkFunctionStatus();
                    // const redirect = await checkAndRedirect();

                    // if (hasdrected === false && window.location.href === 'http://10.204.227.151:30080'){
                    //     window.location.href = 'http://127.0.0.1:5000';
                    // }

                    // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
                    if (isCompleted) {
                        enableButton(topPageButton);
                        console.log("ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ");

                        nothingPagesMessage.classList.add("enabled");
                    }

                    // é€²è¡ŒçŠ¶æ³ã«ã‚ˆã‚‹ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                    let isAnyButtonEnabled = false;
                    progressData.forEach((item, index) => {
                        const button = document.querySelector(`[data-path="${item.path}"]`);
                        if (item.value === 1 && !completionFlags[index]) {
                            completionFlags[index] = true;
                            enableButton(button);
                            isAnyButtonEnabled = true;
                            console.log(`${item.path} ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ`);
                        }
                    });

                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º/éè¡¨ç¤º
                    if (isAnyButtonEnabled) {
                        nothingPagesMessage.classList.add("enabled");
                    }
                    // } else {
                    //     nothingPagesMessage.classList.remove("enabled");
                    // }

                    // å…¨ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹åŒ–ã•ã‚ŒãŸã‚‰ç›£è¦–ã‚’çµ‚äº†
                    if (completionFlags.every(flag => flag) && isCompleted) {
                        // hasdrected = true;
                        clearInterval(interval);

                        console.log("å…¨ã¦ã®ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ");
                    }
                } catch (error) {
                    console.error("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                    clearInterval(interval);
                }
            }, 1000);
        }

        document.addEventListener("DOMContentLoaded", monitorProgressAndStatus);
    </script>
</body>
</html>
