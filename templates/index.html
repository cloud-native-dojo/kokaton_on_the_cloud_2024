<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }
        .section {
            width: 100%;
            height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #startButton {
            padding: 10px 20px;
            font-size: 18px;
            color: white;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #startButton:hover {
            background-color: #0056b3;
        }

        h1 {
            font-size: 36px;
            margin: 0;
            text-align: center;
        }
        h2 {
            font-size: 30px;
            margin: 0;
            text-align: center;
        }

        #top-page {
            border: double 5px gray;
            margin-top: 50px;
            margin-bottom: 10%;
            padding: 10px 20px;
            font-size: 20px;
            color: black;
            border-radius: 5px;
            cursor: pointer;
        }

        #top-page:hover {
            background-color: #0056b3;
            color: white;
        }

        .progress-container {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .button {
            border: double 5px gray;
            padding: 15px 30px;
            font-size: 20px;
            background-color: white;
            color: black;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
            visibility: hidden; 
        }

        .button.enabled {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }

        #iframe-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .nothing-pages {
            position: absolute;
            margin-top: 15%;
        }
        .nothing-pages.enabled {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 移行中臨時サイト -->
    <div class="section">
        <h1>⚠️メンテナンスのため、サイトの機能を一部制限しています⚠️</h1>
        <h2>ご不便をおかけしてしまい申し訳ありません<br>👇アクセス可能なページは以下となっています👇</h2>
        <h3 class="nothing-pages" id="nothing-pages">アクセス可能な他ページはまだありません</h3>
        <button id="top-page" data-path="http://10.204.227.151:30080/" class="button">トップページ</button>
        <div class="progress-container">
            <button id="cart" data-path='http://10.204.227.151:30080/cart' class="button">お買い物カゴ</button>
            <button id="info" data-path='http://10.204.227.151:30080/info' class="button">インフォ</button>
            <button id="shop" data-path='http://10.204.227.151:30080/shop' class="button">ショップ</button>
            <button id="account" data-path="http://10.204.227.151:30080/my-account" class="button">マイアカウント</button>
            <button id="pay" data-path="http://10.204.227.151:30080/checkout" class="button">支払い</button>
        </div>
    </div>

    <!-- オリジナルサイト -->
    <!-- <div class="section" id="iframe-container">
        <iframe src="http://10.204.227.151:30080/"></iframe>
    </div> -->

    <script>
        // let hasdrected = false;

        // async function checkAndRedirect() {
        //     try {
        //         const response = await fetch('/check-variable'); // サーバーにGETリクエスト
        //         if (!response.ok) {
        //             throw new Error('サーバーエラーが発生しました');
        //         }

        //         const data = await response.json();
        //         if (data.redirect) {
        //             // リダイレクトがTrueの場合は指定されたURLに移動
        //             window.location.href = data.url;
        //         } else {
        //             console.log("リダイレクトは不要です");
        //         }
        //     } catch (error) {
        //         console.error('エラー:', error);
        //     }
        // }

        async function checkFunctionStatus() {
            try {
                const response = await fetch('/check-status');
                if (!response.ok) {
                    throw new Error("Failed to fetch function status");
                }
                const data = await response.json();
                return data.completed;
            } catch (error) {
                console.error("Error checking function status:", error);
                return false;
            }
        }

        async function fetchProgress() {
            try {
                const response = await fetch('/progress');
                if (!response.ok) {
                    throw new Error("Failed to fetch progress data");
                }
                return await response.json();
            } catch (error) {
                console.error("Error fetching progress:", error);
                return null;
            }
        }

        function enableButton(button) {
            if (button) {
                button.classList.add("enabled");
                 // クリックイベントを登録
                button.addEventListener("click", () => {
                    const path = button.getAttribute("data-path");
                    if (path) {
                        window.location.href = path; // URLにリダイレクト
                    }
                });
            }
        }

        async function monitorProgressAndStatus() {
            const buttons = document.querySelectorAll("[data-path]");
            const completionFlags = Array.from(buttons).map(() => false);
            const nothingPagesMessage = document.getElementById("nothing-pages");
            const topPageButton = document.getElementById("top-page");

            const interval = setInterval(async () => {
                try {
                    const progressData = await fetchProgress();
                    const isCompleted = await checkFunctionStatus();
                    // const redirect = await checkAndRedirect();

                    // if (hasdrected === false && window.location.href === 'http://10.204.227.151:30080'){
                    //     window.location.href = 'http://127.0.0.1:5000';
                    // }

                    // トップページボタンの有効化
                    if (isCompleted) {
                        enableButton(topPageButton);
                        console.log("トップページボタンが有効になりました");

                        nothingPagesMessage.classList.add("enabled");
                    }

                    // 進行状況によるボタン有効化
                    let isAnyButtonEnabled = false;
                    progressData.forEach((item, index) => {
                        const button = document.querySelector(`[data-path="${item.path}"]`);
                        if (item.value === 1 && !completionFlags[index]) {
                            completionFlags[index] = true;
                            enableButton(button);
                            isAnyButtonEnabled = true;
                            console.log(`${item.path} ボタンが有効になりました`);
                        }
                    });

                    // メッセージ表示/非表示
                    if (isAnyButtonEnabled) {
                        nothingPagesMessage.classList.add("enabled");
                    }
                    // } else {
                    //     nothingPagesMessage.classList.remove("enabled");
                    // }

                    // 全ボタンが有効化されたら監視を終了
                    if (completionFlags.every(flag => flag) && isCompleted) {
                        // hasdrected = true;
                        clearInterval(interval);

                        console.log("全てのボタンが有効になりました");
                    }
                } catch (error) {
                    console.error("エラーが発生しました:", error);
                    clearInterval(interval);
                }
            }, 1000);
        }

        document.addEventListener("DOMContentLoaded", monitorProgressAndStatus);
    </script>
</body>
</html>
