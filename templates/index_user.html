<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§»è¡Œé€²æ—UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }
        .section {
            width: 100%;
            height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center; /* æ°´å¹³æ–¹å‘ä¸­å¤®æƒãˆ */
            justify-content: center; /* å‚ç›´æ–¹å‘ä¸­å¤®æƒãˆ */
        }
        
        #startButton {
            padding: 10px 20px;
            font-size: 18px;
            color: white;
            background-color: #edf6ff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #startButton:hover {
            background-color: #d2d2d2;
        }

        h1 {
            font-size: 36px;
            margin: 0;
            text-align: center;
        }
        h2 {
            font-size: 30px;
            margin: 0;
            text-align: center;
        }

        #top-page {
            border: double 5px gray;
            margin-top: 50px; /* ä¸Šéƒ¨ã®ä½™ç™½èª¿æ•´ */
            margin-botttom: 10%;
            padding: 10px 20px;
            font-size: 20px;
            color: black;
            border-radius: 5px;
            cursor: pointer;
        }

        #top-page:hover {
            background-color: #0056b3;
            color: white;
        }

        .progress-container {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .button {
            border: double 5px gray;
            padding: 15px 30px;
            font-size: 20px;
            background-color: white;
            color: black;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
            visibility: hidden; /* åˆæœŸçŠ¶æ…‹ã§éè¡¨ç¤º */
        }

        .button.enabled {
            opacity: 1;
            pointer-events: auto;
            visibility: visible; /* æœ‰åŠ¹æ™‚ã«è¡¨ç¤º */
        }

        #iframe-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .nothing-pages {
            position: absolute;
            margin-top: 15%;
        }
        .nothing-pages.enabled {
            display: none; /* å®Œå…¨ã«éè¡¨ç¤º */
        }
        
    </style>
</head>

<body>
    <!--ç§»è¡Œä¸­ è‡¨æ™‚ã‚µã‚¤ãƒˆ-->
    <div class="section">
        <button id="startButton">ğŸ³ğŸ²ğŸ˜¼ğŸ˜ˆ</button>
        <h1>âš ï¸ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŸã‚ã€ã‚µã‚¤ãƒˆã®æ©Ÿèƒ½ã‚’ä¸€éƒ¨åˆ¶é™ã—ã¦ã„ã¾ã™âš ï¸</h1>
        <h2>ã”ä¸ä¾¿ã‚’ãŠã‹ã‘ã—ã¦ã—ã¾ã„ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“<br>ğŸ‘‡ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒšãƒ¼ã‚¸ã¯ä»¥ä¸‹ã¨ãªã£ã¦ã„ã¾ã™ğŸ‘‡</h2>
        <h3 class="nothing-pages" id="nothing-pages">ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªä»–ãƒšãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</h3>
        <button id="top-page", class="button">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</button>
        <div class="progress-container">
            <button id="cart" class="button">ãŠè²·ã„ç‰©ã‚«ã‚´</button>
            <button id="info" class="button">ã‚¤ãƒ³ãƒ•ã‚©</button>
            <button id="shop" class="button">ã‚·ãƒ§ãƒƒãƒ—</button>
            <button id="account" class="button">ãƒã‚¤ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
            <button id="pay" class="button">æ”¯æ‰•ã„</button>
        </div>
    </div>

    <!--ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚µã‚¤ãƒˆ-->
    <div class="section" id="iframe-container">
        <iframe src="http://10.204.227.151:30080/"></iframe>
    </div>
</body>

<script>
    //// å‡¦ç†ã«ã‚ˆã‚Šãƒœã‚¿ãƒ³ã‚’å‡ºç¾ã•ã›ã‚‹é–¢æ•°
    const emergedButton = (id, progress, completedFlag, firstText=true, firstElementText=null) => {
        if (!completedFlag) {
            if (progress >= 100) {
                // ã€Œè¡¨ç¤ºå¯èƒ½é …ç›®ãªã—ã€ã‚’çŸ¥ã‚‰ã›ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆæœ€åˆã ã‘ã®å‡¦ç†ï¼‰
                if (!firstText) {
                    firstElementText.classList.add("enabled");
                }
                completedFlag = true; // åˆ¥é …ç›®ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰²ãã¹ãã€ã“ã®é …ç›®ã¸ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ­¢ã‚ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
                const element = document.getElementById(id);
                element.classList.add("enabled"); 
                element.addEventListener("click", () => {
                    window.open(item.url, "_blank");
                });
                console.log(id + " was accomplished."); //debug
            } else {
                progress = Math.min(progress + Math.random() * 10, 100); // 100%æœªæº€ãªã‚‰è¨ˆç®—ã—ã¦è¿”ã™
            }
        }
        return progress, completedFlag
    }


    //// ç§»è¡Œé–‹å§‹ ////
    fetch("/user", {
        method: "GET"
        // ãƒœã‚¿ãƒ³ã‚’è‡ªå‹•ã§æŠ¼ã™
        
    })
    document.getElementById("startButton").addEventListener("click", () => {
        //// AJAXãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦jsonãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— ////
        fetch("/migrate", {
            method: "POST",
        })
        .then(response => response.json())
        .then(data => {
            
            let filesArray = data.all_elmes;
            let priorSendingPercent = data.Scores;

            // ã‚¹ã‚³ã‚¢ã‚’å®šæœŸçš„ã«æ›´æ–°ã™ã‚‹
            setInterval(() => {
                fetch("/get_scores", {
                    method: "GET"
                })
                .then(response => response.json())
                .then(data => {
                    // æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
                    let priorSendingPercent = data.Scores;
                    console.log("Updated Scores:", data);  // ãƒ‡ãƒãƒƒã‚°ç”¨
                })
                .catch(error => console.error("Error fetching updated scores:", error));
            }, 5000);

            //// é–¢æ•°å®šç¾© ////
            // é…åˆ—ã®åˆè¨ˆå€¤ã‚’æ±‚ã‚ã‚‹é–¢æ•°
            const sumNumbers = numbers => numbers.reduce((previousValue,currentValue) => previousValue + currentValue, 0);

            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚ŒãŸé…åˆ—ã‹ã‚‰ã€configã¨åã®ä»˜ããƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’æŠ½å‡ºã—ã€æ ¼ç´ã—ãŸé…åˆ—ã‚’è¿”ã™é–¢æ•°
            const exploreConfigFiles = (filesArray) => {
                let configIdxesArray = []; // å¾Œã§æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã€configãƒ•ã‚¡ã‚¤ãƒ«ã®æ·»å­—ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®é…åˆ—
                for (let i = 0; i < filesArray.length; i++) {
                    
                    // é…åˆ—ã®ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒ "config" ã‚’å«ã‚€å ´åˆ
                    if (filesArray[i].includes("config")) {
                        configIdxesArray.push(i); // configå‡ºç¾ä½ç½®ã‚’é…åˆ—ã«æ ¼ç´
                    };
                };
                return configIdxesArray; //ğŸ“„â€»ã¨ã‚Šã‚ãˆãšä»Šå›ã¯ã€ã“ã®è¦ç´ æ•°ã ã‘åˆ©ç”¨ã™ã‚‹.
            };

            // ç§»è¡Œé‡ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹ãŸã‚ã®è¨ˆç®—ã™ã‚‹é–¢æ•°
            const calcQuantity = (currentLevel, totalNum, ratio=1.0, batchSize=110) => {
                if (currentLevel < totalNum) {
                    currentLevel += batchSize * ratio;
                    //let percentage = (currentLevel / totalNum) * 100;  
                }
                return currentLevel;
            };

            // ãƒœã‚¿ãƒ³ã‚’å‡ºç¾ã•ã›ã‚‹é–¢æ•°
            const enableButton = (element, displayedTopPage=true, hiddenTextElement) => {
                // äº‹å‰è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã®éè¡¨ç¤º
                if (!displayedTopPage) {
                    console.log("In advance text is hidden.");
                    hiddenTextElement.classList.add("enabled");
                }
                // ãƒœã‚¿ãƒ³è¡¨ç¤ºãƒ»ã‚¯ãƒªãƒƒã‚«ãƒ–ãƒ«
                element.classList.add("enabled");
                element.addEventListener("click", function () {
                    window.open(item.url, "_blank");
                });
            };


            //// å…¨ä½“å‡¦ç† ////
            // ç§»è¡Œå®¹é‡ã®å¤‰æ•°ã‚’å®šç¾©
            let baseLevel = 0; // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
            let otherItemLevels = [0, 0, 0, 0, 0];
            let invisibleLevel = 0; // ç®¡ç†è€…å´ã§ã„ã†ã€Œãã®ä»–ã€ãƒšãƒ¼ã‚¸
            let tmpPercentage = 0; // è‡¨æ™‚ã€‚othersã®ã¿
            // ç§»è¡Œå®Œäº†ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
            let baseFull = false;
            let shopComplete = false, payComplete = false, cartComplete = false, accountComplete = false, infoComplete = false; // æº€ã‚¿ãƒ³ã®å ´åˆã‚’æ¤œçŸ¥ã™ã‚‹ãƒ•ãƒ©ã‚°ï¼ˆãƒã‚¤ãƒ‘ãƒ¼ãƒªãƒ³ã‚¯æŒ¿å…¥ã®ãŸã‚ï¼‰
            // htmlã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆå–å¾—
            const nothingPagesText = document.getElementById("nothing-pages");
            const topPage = document.getElementById("top-page");
            const otherItems = [
                document.getElementById("cart"),
                document.getElementById("info"),
                document.getElementById("shop"),
                document.getElementById("account"),
                document.getElementById("pay")
            ];

            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åˆæœŸè¨­å®š
            topPage.classList.remove("enabled");
            otherItems.forEach(otherItem => {
                otherItem.classList.remove("enabled");
            })
            
            // å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«æ•°å‰²ã‚Šå½“ã¦
            const configIdxesArray = exploreConfigFiles(filesArray); // é–¢æ•°å‘¼ã³å‡ºã—
            const totalFiles = filesArray.length // å…¨ãƒ•ã‚¡ã‚¤ãƒ«æ•°
            const totalConfig = configIdxesArray.length; // conifgãƒ•ã‚¡ã‚¤ãƒ«æ•°
            const totalColumns =  (totalFiles - totalConfig) * (1/3); // configä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã®ã†ã¡ã€é …ç›®
            const totalOthers =  (totalFiles - totalConfig) * (2/3) ; // configä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã®ã†ã¡ã€é …ç›®ã‚‚é™¤ã„ãŸãã®ä»–
            const colNames = ["cart", "info", "shop", "account", "pay"]; // é …ç›®åã®é †åº

            // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã§å‡¦ç†
            const interval = setInterval(() => {
                // toppageãŒæº€ã‚¿ãƒ³ã«ãªã‚‹ã¾ã§ç§»è¡Œ
                if (!baseFull) {
                    baseLevel = calcQuantity(baseLevel, totalConfig);
                    if (baseLevel >= totalConfig) {
                        baseFull = true; // ã‚‚ã†ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰²ã‹ãªã„
                        enableButton(topPage, false, nothingPagesText);
                        console.log("Top-page was completed, switching to other pages.");
                    }
                } else if (baseFull && !(cartComplete&&infoComplete&&shopComplete&&accountComplete&&payComplete)) {
                    otherItems.forEach((itemElement, index) => {
                        const colName = colNames[index]; // å„é …ç›®ã®åå‰ã‚’ã—ã¦ã„
                        otherItemLevels[index] = calcQuantity(otherItemLevels[index], totalColumns, ratio=priorSendingPercent[colName]);

                        // account
                        if (otherItems[3] >= totalColumns && !accountComplete) {
                            accountComplete = true;
                            enableButton(otherItems[3]);
                            console.log("Account is full, redistributing priorities.");
                            // Pythonã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                            fetch('http://127.0.0.1:5000/account_trigger', { // Flaskã‚µãƒ¼ãƒãƒ¼ã®URL
                                method: 'POST',
                                // headers: {
                                //     'Content-Type': 'application/json',
                                // },
                                // body: JSON.stringify({ message: "Triggered from JavaScript" }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                priorSendingPercent = data.Scores;
                            })
                            .catch(error => {
                                        console.error('Error:', error);
                            });
                        }

                        // shop
                        if (otherItemLevels[2] >= totalColumns && !shopComplete) {
                            shopComplete = true;
                            enableButton(otherItems[2]);
                            console.log("Shop is full, redistributing priorities.");

                            // Pythonã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                            fetch('http://127.0.0.1:5000/shop_trigger', { // Flaskã‚µãƒ¼ãƒãƒ¼ã®URL
                                method: 'POST',
                                // headers: {
                                //     'Content-Type': 'application/json',
                                // },
                                // body: JSON.stringify({ message: "Triggered from JavaScript" }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                priorSendingPercent = data.Scores;
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                        }

                        // cart
                        if (otherItemLevels[0] >= totalColumns && !cartComplete) {
                            cartComplete = true;
                            enableButton(otherItems[0]);
                            console.log("Cart is full, redistributing priorities.");

                            // Pythonã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                            fetch('http://127.0.0.1:5000/cart_trigger', { // Flaskã‚µãƒ¼ãƒãƒ¼ã®URL
                                method: 'POST',
                                // headers: {
                                //     'Content-Type': 'application/json',
                                // },
                                // body: JSON.stringify({ message: "Triggered from JavaScript" }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                priorSendingPercent = data.Scores;
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                        }

                        // info
                        if (otherItemLevels[1] >= totalColumns && !infoComplete) {
                            infoComplete = true;
                            enableButton(otherItems[1]);
                            console.log("Info is full, redistributing priorities.");

                            // Pythonã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                            fetch('http://127.0.0.1:5000/info_trigger', { // Flaskã‚µãƒ¼ãƒãƒ¼ã®URL
                                method: 'POST',
                                // headers: {
                                //     'Content-Type': 'application/json',
                                // },
                                // body: JSON.stringify({ message: "Triggered from JavaScript" }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                priorSendingPercent = data.Scores;
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                        }
                        
                        // pay
                        if (otherItemLevels[4] >= totalColumns && !payComplete) {
                            payComplete = true;
                            enableButton(otherItems[4]);
                            console.log("Pay is full, redistributing priorities.");

                           // Pythonã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                           fetch('http://127.0.0.1:5000/checkout_trigger', { // Flaskã‚µãƒ¼ãƒãƒ¼ã®URL
                               method: 'POST',
                               // // headers: {
                               // //     'Content-Type': 'application/json',
                               // // },
                               // body: JSON.stringify({ message: "Triggered from JavaScript" }),
                           })
                           .then(response => response.json())
                           .then(data => {
                               priorSendingPercent = data.Scores;
                           })
                           .catch(error => {
                               console.error('Error:', error);
                           });                                
                        }
                    }); // forEach
                } else if (baseFull && (cartComplete&&infoComplete&&shopComplete&&accountComplete&&payComplete)) {
                    if (invisibleLevel < totalOthers) {
                        invisibleLevel += 110 * 1.0;
                        //tmpPercentage = (invisibleLevel / totalOthers) * 100;  
                    }
                    if (invisibleLevel >= totalOthers) {
                        console.log("other tank is full. This migration is completedğŸ˜¼!!");
                    }
                }
                // å…¨ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡å¾Œã¯åœæ­¢
                if (otherItemLevels.every(level => level >= totalColumns) && (invisibleLevel >= totalOthers)) {
                    clearInterval(interval);
                    alert("å…¨ã¦ã®ç§»è¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸï¼");
                    console.log(totalFiles);
                    console.log(filesArray);
                }
            }, 100); // æ°´æ»´ã®é–“éš” interval
        }) //.then
        .catch(error => {
            console.error("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚:", error);
        }) // .catch
    }); // .addEventListener
    </script>
</body>
</html>